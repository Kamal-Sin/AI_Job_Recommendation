{% extends "base.html" %} {% block title %}Recommendations | Job Recommendation
AI{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h3 class="mb-3">Recommended Jobs</h3>

    <!-- User Skills Display -->
    <div id="skills-display" class="mb-4" style="display: none">
      <h5>Your Skills:</h5>
      <div id="skills-badges" class="mb-3"></div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center mb-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading job recommendations...</p>
    </div>

    <!-- Error Message -->
    <div
      id="error-message"
      class="alert alert-warning"
      style="display: none"
    ></div>

    <!-- Recommendations Container -->
    <div id="reco-container" class="row g-3"></div>

    <!-- Empty State -->
    <div id="reco-empty" class="text-center text-muted" style="display: none">
      <p>
        No job recommendations available. Please add skills to your profile.
      </p>
      <a href="/" class="btn btn-primary">Go to Dashboard</a>
    </div>
  </div>
</div>

<script>
  function requireAuth() {
    const token = localStorage.getItem("access_token");
    if (!token) {
      window.location.href = "/login/";
    }
    return token;
  }

  function getScoreColor(score) {
    if (score >= 0.7) return "success";
    if (score >= 0.4) return "warning";
    return "secondary";
  }

  async function loadRecommendations() {
    const token = requireAuth();
    const container = document.getElementById("reco-container");
    const empty = document.getElementById("reco-empty");
    const loading = document.getElementById("loading");
    const errorDiv = document.getElementById("error-message");
    const skillsDisplay = document.getElementById("skills-display");
    const skillsBadges = document.getElementById("skills-badges");

    // Hide all initially
    container.innerHTML = "";
    empty.style.display = "none";
    errorDiv.style.display = "none";
    skillsDisplay.style.display = "none";
    loading.style.display = "block";

    try {
      const res = await fetch("/job/recommendations/", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      loading.style.display = "none";

      if (!res.ok || data.error) {
        errorDiv.textContent = data.error || "Failed to load recommendations.";
        errorDiv.style.display = "block";
        if (data.error && data.error.includes("No skills")) {
          empty.style.display = "block";
        }
        return;
      }

      // Display user skills
      if (data.user_skills && data.user_skills.length > 0) {
        skillsDisplay.style.display = "block";
        skillsBadges.innerHTML = data.user_skills
          .map(
            (skill) => `<span class="badge bg-info me-2 mb-2">${skill}</span>`
          )
          .join("");
      }

      if (data.recommendations && data.recommendations.length > 0) {
        empty.style.display = "none";

        // Sort by score (highest first)
        const sortedJobs = data.recommendations.sort(
          (a, b) => b.score - a.score
        );

        sortedJobs.forEach((job, index) => {
          const col = document.createElement("div");
          col.className = "col-md-6 col-lg-4 mb-3";

          const scoreColor = getScoreColor(job.score);
          const scorePercent =
            job.score_percentage || (job.score * 100).toFixed(2);

          col.innerHTML = `
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">${job.job_title || "N/A"}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${
                  job.company || "N/A"
                }</h6>
                <p class="card-text">
                  <small class="text-muted">
                    <i class="bi bi-geo-alt"></i> ${
                      job.location || "Location not specified"
                    }
                  </small>
                </p>
                <div class="mt-3">
                  <span class="badge bg-${scoreColor} me-2">
                    Match: ${scorePercent}%
                  </span>
                  <span class="badge bg-secondary">
                    Score: ${job.score.toFixed(4)}
                  </span>
                </div>
                ${
                  index === 0
                    ? '<span class="badge bg-success mt-2">Best Match</span>'
                    : ""
                }
              </div>
            </div>`;
          container.appendChild(col);
        });

        // Show stats if available
        if (data.total_jobs_analyzed) {
          const statsDiv = document.createElement("div");
          statsDiv.className = "col-12 mt-3";
          statsDiv.innerHTML = `
            <div class="alert alert-info">
              <strong>Analysis:</strong> Analyzed ${data.total_jobs_analyzed} jobs, 
              found ${data.matching_jobs} matching positions based on your skills.
            </div>`;
          container.appendChild(statsDiv);
        }
      } else {
        empty.style.display = "block";
      }
    } catch (e) {
      loading.style.display = "none";
      errorDiv.textContent =
        "An error occurred while loading recommendations. Please try again.";
      errorDiv.style.display = "block";
      console.error("Error loading recommendations:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", loadRecommendations);
</script>
{% endblock %}
